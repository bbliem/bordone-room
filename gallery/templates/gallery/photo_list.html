{% extends "gallery/base.html" %}
{% load static %}
{% load custom_tags %}

{% block header %}
{{ block.super }}
{% include "gallery/justified_gallery_header.html" %}
<script src="{% static 'gallery/js.cookie.js' %}" defer></script>
{# https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script #}
<script>
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
document.addEventListener('DOMContentLoaded', function() {
  // XXX Remember (from https://docs.djangoproject.com/en/2.1/ref/csrf/#ajax):
  // If your view is not rendering a template containing the csrf_token template tag, Django might not set the CSRF token cookie. This is common in cases where forms are dynamically added to the page. To address this case, Django provides a view decorator which forces setting of the cookie: ensure_csrf_cookie().
  var csrftoken = Cookies.get('csrftoken');
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
      }
  });
});
</script>
<script src="{% static 'gallery/photo_batch_edit.js' %}" defer></script>
{% endblock %}

{% block content %}
<div id="edit-sidebar" style="display: none">
  <select id="select_albums" multiple>
    {% for album in albums %}
      <option value="{{ album.id }}">{{ album.title }}</option>
    {% endfor %}
  </select>
</div>

<button id="open-edit-sidebar" onclick="openEditSidebar()">&#9776;</button>

<section>
  <h1>Photos</h1>
  {% if photo_list %}
    <div id="gallery">
      {% for photo in photo_list %}
        <a href="{% url 'gallery:photo_detail' photo.id %}">
          <img alt="{{ photo.name }}" src="{{ photo.thumbnail.url }}"
               data-photo="{{ photo.id }}"
               data-albums="[{{ photo.album_set|sort_by:'id'|key_to_list:'id'|join:',' }}]">
        </a>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <div class="pagination">
          <span class="step-links">
              {% if page_obj.has_previous %}
                  <a href="?page=1">&laquo; first</a>
                  <a href="?page={{ page_obj.previous_page_number }}">previous</a>
              {% endif %}

              <span class="current">
                  Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
              </span>

              {% if page_obj.has_next %}
                  <a href="?page={{ page_obj.next_page_number }}">next</a>
                  <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
              {% endif %}
          </span>
      </div>
    {% endif %}
  {% else %}
    <p>There are no photos.</p>
  {% endif %}
</section>

<section>
  <h1>Upload</h1>
  <form enctype="multipart/form-data" method="post" action="{% url 'gallery:photo_list' %}">
    {% csrf_token %}
    {{ upload_form }}
    <!--<input type="file" name="photos" multiple>-->
    <input type="submit" value="Upload">
  </form>
</section>
{% endblock %}
